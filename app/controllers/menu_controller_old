class MenuController < UIViewController 


  def viewDidLoad
    super

    rmq.stylesheet = MenuControllerStylesheet
    rmq(self.view).apply_style :root_view

    @data = ["Nel baule", "Da fare", "In sospeso", "Cronologia"]
    @clienti = []

    init_background

    @search_bar = rmq.append(UISearchBar, :search_bar).get
    @search_controller = UISearchDisplayController.alloc.initWithSearchBar(@search_bar, contentsController:self).tap do |sc|
      sc.delegate = self
      sc.searchResultsDataSource = self
      sc.searchResultsDelegate = self
    end      
    @menu_table_view = rmq.append(UITableView, :menu_table_view).get
    @menu_table_view.delegate = self
    @menu_table_view.dataSource = self

  end
  
  
  def init_background

    self.view.backgroundColor = UIColor.grayColor    
    @backgroundImageView = UIImageView.alloc.initWithImage UIImage.imageNamed("galaxy")
    @backgroundImageView.translatesAutoresizingMaskIntoConstraints = false
    
    imageViewRect = UIScreen.mainScreen.bounds
    imageViewRect.size.width += 589
    @backgroundImageView.frame = imageViewRect;
    @backgroundImageView.contentMode = UIViewContentModeScaleAspectFit;
    self.view.addSubview @backgroundImageView

    viewDictionary = { "imageView" => @backgroundImageView }
    self.view.addConstraints(NSLayoutConstraint.constraintsWithVisualFormat("H:|-0-[imageView]", options:0, metrics:nil, views:viewDictionary))

    self.view.addConstraints(NSLayoutConstraint.constraintsWithVisualFormat("V:|-0-[imageView]", options:0, metrics:nil, views:viewDictionary))
  
  end


  def resetImage(originalImage)

    newSize = CGSizeMake(38, 38)
    imageRect = CGRectMake( 0, 0, newSize.width, newSize.height)

    UIGraphicsBeginImageContext(newSize)
    originalImage.drawInRect(imageRect)
    theImage = UIGraphicsGetImageFromCurrentImageContext()
    UIGraphicsEndImageContext()

    return theImage
  end


#pragma mark - tableViewDelegates


  def tableView(tableView, numberOfRowsInSection: section)
    if tableView == @menu_table_view
      @data.count
    else
      @clienti.count
    end
  end


  def tableView(tableView, cellForRowAtIndexPath: indexPath)
    
    if tableView == @menu_table_view
      @menuIdentifier ||= "menu_cell"
      cell = tableView.dequeueReusableCellWithIdentifier(@menuIdentifier)
      unless cell
        cell = UITableViewCell.alloc.initWithStyle(UITableViewCellStyleSubtitle, reuseIdentifier:@menuIdentifier)
      end
      cell.textLabel.color = COLORS[indexPath.row]
      cell.textLabel.text = @data[indexPath.row]
      cell.imageView.image = resetImage "#{MENU_IMAGES[indexPath.row]}-on35".uiimage
      cell.backgroundColor = UIColor.clearColor
    else
      @clienteIdentifier ||= "cliente_cell"
      cell = tableView.dequeueReusableCellWithIdentifier(@clienteIdentifier)
      unless cell
        cell = UITableViewCell.alloc.initWithStyle(UITableViewCellStyleDefault, reuseIdentifier:@clienteIdentifier)
      end
      cell.textLabel.text = @clienti[indexPath.row].nome
    end
    cell
  end


  def tableView(tableView, heightForRowAtIndexPath:indexPath)
    50
  end


  def tableView(tableView, didSelectRowAtIndexPath:indexPath)

    tableView.deselectRowAtIndexPath(indexPath, animated:false)
    cell = tableView.cellForRowAtIndexPath indexPath

    if tableView == @menu_table_view
      if indexPath.row == 0
        query = Cliente.per_provincia.nel_baule
      elsif indexPath.row == 1
        query = Cliente.per_provincia.da_fare
      elsif indexPath.row == 2
        query = Cliente.per_provincia.in_sospeso
      # elsif indexPath.row == 3
      #   query = Cliente.tutti
      end

      if indexPath.row <= 2
        controller = UINavigationController.alloc.initWithRootViewController ClientiController.alloc.initWithCDQQuery(query, andTitle:cell.textLabel.text, andColor:COLORS[indexPath.row])
      else
        controller = UINavigationController.alloc.initWithRootViewController AppuntiController.alloc.initWithCDQQuery(Appunto.cronologia, andTitle:"cronologia", andColor:nil)
        controller.topViewController.init_nav
        controller.topViewController.show_cliente = true
      end

    else

      cliente = @clienti[indexPath.row]

      controller = UINavigationController.alloc.initWithRootViewController ClienteAppuntiController.alloc.initWithCliente(cliente)
      controller.topViewController.init_nav
      
    end

    #rmq(self.sideMenuViewController.mainViewController.view).animations.fade_out(duration: 1.5)
    self.sideMenuViewController.setMainViewController controller, animated:true, closeMenu:true 
    
    if @old then
      puts @old
      #@old.removeFromSuperview
      #@old.release
    end

    @old = controller
    @search_controller.active = false

  end


#pragma mark - searchDisplayDelegates
 

  def searchDisplayController(controller, shouldReloadTableForSearchString:searchString)
    query = Cliente.per_provincia.where("nome contains[cd] '#{searchString}'").or("comune contains[cd] '#{searchString}'").or("frazione contains[cd] '#{searchString}'")
    
    @clienti = query
    true
  end


  def searchDisplayControllerWillBeginSearch(controller)
    rmq(self.sideMenuViewController.mainViewController.view).animations.fade_out    
  end


  def searchDisplayControllerDidEndSearch(controller)
    rmq(self.sideMenuViewController.mainViewController.view).animations.fade_in
  end


end



